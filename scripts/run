#!/usr/bin/env bash

# Debug|Release
CONFIGURATION=Release

set -e

APP_HOME="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && cd .. && pwd )/"
cd $APP_HOME

check_dependencies() {
    set +e

    TEST=$(which nuget)
    if [[ -z "$TEST" ]]; then
        echo "ERROR: 'nuget' command not found. Install Mono 5.x first (http://www.mono-project.com/docs/about-mono/releases/5.0.0)."
        exit 1
    fi

    TEST=$(which msbuild)
    if [[ -z "$TEST" ]]; then
        echo "ERROR: 'msbuild' command not found. Install Mono 5.x first (http://www.mono-project.com/docs/about-mono/releases/5.0.0)."
        exit 1
    fi

    TEST=$(which mono)
    if [[ -z "$TEST" ]]; then
        echo "ERROR: 'mono' command not found. Install Mono 5.x first (http://www.mono-project.com/docs/about-mono/releases/5.0.0)."
        exit 1
    fi
    set -e
}

check_dependencies

echo "Building..."
nuget restore
msbuild /m /p:Configuration=$CONFIGURATION /verbosity:quiet

echo "Starting web service..."
cd $APP_HOME/WebService/bin/$CONFIGURATION/
mono Microsoft.Azure.IoTSolutions.DeviceSimulation.WebService.exe
